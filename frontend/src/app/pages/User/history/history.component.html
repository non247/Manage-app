<div class="layout">
  <!-- Main content -->
  <div class="main-area">
    <div class="main-content">
      <header class="top-navbar">
        <h1>ประวัติการขาย</h1>
      </header>

      <!-- ✅ ใส่ table ในกล่อง table-box -->
      <div class="table-box">
        <div
          class="header-row"
          style="
            display: flex;
            align-items: center;
            width: 100%;
            position: relative;
          "
        >
          <!-- ขวา: ปุ่ม Excel -->
          <button
            type="button"
            class="btn-excel"
            style="margin-left: auto"
            (click)="exportToExcel()"
          >
            <i class="bi bi-filetype-xlsx"></i>
          </button>
          <!-- CREATE -->
          <button
            class="btn-add"
            style="margin-left: 10px"
            (click)="showCreateForm = !showCreateForm"
          >
            <i class="bi bi-plus-circle-fill"></i> เพิ่มข้อมูล
          </button>
        </div>

        <!-- BACKDROP -->
        <div
          *ngIf="showCreateForm"
          class="create-backdrop"
          [class.closing]="isClosing"
          (click)="onCreateCancel()"
        ></div>

        <!-- ✅ CREATE FORM : CARD -->
        <div
          *ngIf="showCreateForm"
          class="create-card"
          [class.closing]="isClosing"
        >
          <div class="create-card-header">
            <h2>เพิ่มรายการขาย</h2>
          </div>

          <div class="create-card-body">
            <div class="create-grid">
              <div class="field">
                <label for="name">ชื่อสินค้า</label>
                <input type="text" pInputText [(ngModel)]="newProduct.name" />
              </div>

              <div class="field">
                <label for="category">ประเภท</label>
                <input
                  type="text"
                  pInputText
                  [(ngModel)]="newProduct.category"
                />
              </div>

              <div class="field">
                <label for="quantity">จำนวน</label>
                <input
                  type="number"
                  pInputText
                  [(ngModel)]="newProduct.quantity"
                  min="0"
                />
              </div>

              <div class="field">
                <label for="price">ราคา</label>
                <input
                  type="number"
                  pInputText
                  [(ngModel)]="newProduct.price"
                  min="0"
                />
              </div>

              <div class="field">
                <label for="date">วันที่</label>
                <input type="date" [(ngModel)]="newProduct.date" />
              </div>
            </div>
          </div>

          <div class="create-card-footer">
            <button class="btn-save" (click)="onCreateSave()">
              <i class="pi pi-check-square"></i> บันทึก
            </button>

            <button class="btn-cancel" (click)="onCreateCancel()">
              <i class="bi bi-x-square"></i> ยกเลิก
            </button>
          </div>
        </div>

        <p-table
          #dt
          [value]="filteredProducts"
          dataKey="code"
          selectionMode="multiple"
          [metaKeySelection]="false"
          [rows]="10"
          [globalFilterFields]="[
            'name',
            'category',
            'quantity',
            'price',
            'date',
          ]"
          [scrollable]="true"
          scrollHeight="500px"
          stripedRows
          [tableStyle]="{ width: '100%', 'table-layout': 'fixed' }"
        >
          <ng-template pTemplate="header">
            <tr>
              <th style="text-align: center; width: 10%">
                <input
                  type="checkbox"
                  [checked]="
                    selectedProducts.length === filteredProducts.length
                  "
                  (change)="onSelectAll($event)"
                  [disabled]="editIndex !== null"
                  style="width: 30px; height: 26px"
                />
              </th>

              <th pSortableColumn="date" scope="col">
                <div class="flex items-center gap-2">
                  วันที่
                  <p-sortIcon field="date"></p-sortIcon>
                </div>
              </th>

              <th pSortableColumn="name" scope="col">
                <div class="flex items-center gap-2">
                  ชื่อสินค้า
                  <p-sortIcon field="name"></p-sortIcon>
                </div>
              </th>

              <th pSortableColumn="category" scope="col">
                <div class="flex items-center gap-2">
                  ประเภท
                  <p-sortIcon field="category"></p-sortIcon>
                </div>
              </th>

              <th pSortableColumn="quantity" scope="col">
                <div class="flex items-center gap-2">
                  จำนวน
                  <p-sortIcon field="quantity"></p-sortIcon>
                </div>
              </th>

              <th pSortableColumn="price" scope="col">
                <div class="flex items-center gap-2">
                  ราคา
                  <p-sortIcon field="price"></p-sortIcon>
                </div>
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-product let-i="rowIndex">
            <tr>
              <td style="text-align: center">
                <input
                  type="checkbox"
                  [checked]="selectedProducts.includes(product)"
                  (change)="onCheckboxChange($event, product)"
                  [disabled]="editIndex !== null"
                  style="width: 24px; height: 24px"
                />
              </td>

              <!-- DATE -->
              <td>
                <ng-container *ngIf="editIndex !== i; else editDate">
                  {{ product.date | date: 'dd/MM/yyyy' }}
                </ng-container>
                <ng-template #editDate>
                  <input type="date" [(ngModel)]="editProduct!.date" />
                </ng-template>
              </td>
              <!-- NAME -->
              <td>
                <ng-container *ngIf="editIndex !== i; else editName">
                  {{ product.name }}
                </ng-container>
                <ng-template #editName>
                  <input type="text" [(ngModel)]="editProduct!.name" />
                </ng-template>
              </td>

              <!-- CATEGORY -->
              <td>
                <ng-container *ngIf="editIndex !== i; else editCategory">
                  {{ product.category }}
                </ng-container>
                <ng-template #editCategory>
                  <input type="text" [(ngModel)]="editProduct!.category" />
                </ng-template>
              </td>

              <!-- QUANTITY -->
              <td>
                <ng-container *ngIf="editIndex !== i; else editQty">
                  {{ product.quantity }}
                </ng-container>
                <ng-template #editQty>
                  <input type="number" [(ngModel)]="editProduct!.quantity" />
                </ng-template>
              </td>

              <!-- PRICE -->
              <td>
                <ng-container *ngIf="editIndex !== i; else editPrice">
                  {{ product.price }}
                </ng-container>
                <ng-template #editPrice>
                  <input type="number" [(ngModel)]="editProduct!.price" />
                </ng-template>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7">ไม่พบข้อมูล</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>
