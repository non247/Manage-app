<div class="layout">
  <div class="main-area">
    <div class="main-content">
      <header class="top-navbar">
        <h1>รายการสินค้า</h1>
      </header>

      <div class="table-box">
        <!-- HEADER ROW -->
        <div class="header-row search-wrap">
          <i class="bi bi-search"></i>

          <input
            #gb
            type="text"
            class="search-input"
            pInputText
            placeholder="ค้นหา..."
            (input)="dt.filterGlobal(gb.value, 'contains')"
          />

          <button
            class="btn-add"
            style="margin-left: auto"
            (click)="showCreateForm = !showCreateForm"
          >
            <i class="bi bi-plus-circle-fill"></i> เพิ่มข้อมูล
          </button>

          <!-- ✅ เปิดฟอร์มประวัติการขาย -->
          <button
            class="btn-save btn-history"
            type="button"
            (click)="openHistoryForm()"
          >
            <i class="bi bi-send-fill"></i>
            ประวัติการขาย
            <span class="bubble" *ngIf="saleDraftItems.length > 0">
              {{ saleDraftItems.length }}
            </span>
          </button>
        </div>

        <!-- ✅ BACKDROP CREATE -->
        <div
          *ngIf="showCreateForm"
          class="create-backdrop"
          [class.closing]="isClosing"
          (click)="onCreateCancel()"
        ></div>

        <!-- ✅ CREATE FORM : CARD -->
        <div
          *ngIf="showCreateForm"
          class="create-card"
          [class.closing]="isClosing"
        >
          <div class="create-card-header">
            <h2>เพิ่มสินค้า</h2>
          </div>

          <div class="create-card-body">
            <div class="create-grid">
              <!-- NAME -->
              <div class="field">
                <label for="productName">ชื่อสินค้า</label>
                <select
                  id="productName"
                  class="p-inputtext p-component"
                  [(ngModel)]="newProduct.name"
                  name="productName"
                  (change)="onCreateNameChange(newProduct.name)"
                >
                  <option value="" disabled>-- เลือกชื่อสินค้า --</option>
                  <option *ngFor="let n of names" [value]="n.value">
                    {{ n.label }}
                  </option>
                </select>
              </div>

              <!-- CATEGORY -->
              <div class="field">
                <label for="productCategory">ประเภท</label>
                <select
                  id="productCategory"
                  class="p-inputtext p-component"
                  [(ngModel)]="newProduct.category"
                  name="productCategory"
                >
                  <option value="" disabled>-- เลือกประเภท --</option>
                  <option *ngFor="let c of categories" [value]="c.value">
                    {{ c.label }}
                  </option>
                </select>
              </div>

              <!-- QTY -->
              <div class="field">
                <label for="quantity">จำนวน</label>
                <input
                  id="quantity"
                  type="number"
                  pInputText
                  min="1"
                  step="1"
                  [ngModel]="newProduct.quantity"
                  name="productQty"
                  (ngModelChange)="newProduct.quantity = toInt($event, 1)"
                />
              </div>

              <!-- PRICE -->
              <div class="field">
                <label for="price">ราคา</label>
                <input
                  id="price"
                  type="number"
                  pInputText
                  min="0"
                  step="1"
                  [ngModel]="newProduct.price"
                  name="productPrice"
                  readonly
                />
              </div>

              <!-- DATE -->
              <div class="field">
                <label for="date">วันที่</label>
                <input
                  id="date"
                  type="date"
                  [(ngModel)]="newProduct.date"
                  name="productDate"
                  readonly
                />
              </div>
            </div>
          </div>

          <div class="create-card-footer">
            <button class="btn-cancel" (click)="onCreateCancel()">
              <i class="bi bi-x-square"></i> ยกเลิก
            </button>
            <button class="btn-save" (click)="onCreateSave()">
              <i class="pi pi-check-square"></i> บันทึก
            </button>
          </div>
        </div>

        <div
          *ngIf="showHistoryForm"
          class="create-backdrop history-backdrop"
          [class.closing]="isClosingHistory"
          (click)="closeHistoryForm()"
        ></div>

        <!-- ✅ HISTORY FORM CARD -->
        <div
          *ngIf="showHistoryForm"
          class="create-card history-card"
          [class.closing]="isClosingHistory"
          (click)="$event.stopPropagation()"
        >
          <div class="create-card-header">
            <h2>ยืนยันส่งประวัติการขาย</h2>
          </div>

          <div class="create-card-body history-body">
            <!-- SECTION 1: เพิ่มรายการ -->
            <div class="section-box">
              <div class="section-title" style="color: #d81b60">
                <i class="bi bi-plus-circle"></i>
                เพิ่มรายการขาย
              </div>

              <div class="sale-form-row">
                <div class="field">
                  <label>ชื่อสินค้า</label>
                  <select
                    class="p-inputtext p-component"
                    [(ngModel)]="saleForm.productId"
                    name="saleProductId"
                    (change)="onSaleProductChange()"
                  >
                    <option [ngValue]="null" disabled>
                      -- เลือกชื่อสินค้า --
                    </option>
                    <option
                      *ngFor="let p of saleProductOptions"
                      [ngValue]="p.id"
                    >
                      {{ p.name }} (คงเหลือ {{ p.quantity }})
                    </option>
                  </select>
                </div>

                <div class="field">
                  <label>จำนวน</label>
                  <input
                    type="number"
                    class="p-inputtext p-component"
                    min="1"
                    [max]="saleFormMax"
                    [(ngModel)]="saleForm.qty"
                    name="saleQty"
                  />
                </div>

                <div class="field action-field">
                  <button
                    class="btn-save"
                    type="button"
                    (click)="addSaleItem()"
                  >
                    <i class="bi bi-plus-circle-fill"></i> บันทึก
                  </button>
                </div>
              </div>

              <div class="hint" *ngIf="saleFormInfo">{{ saleFormInfo }}</div>
            </div>

            <!-- SECTION 2: รายการที่เพิ่มแล้ว -->
            <div class="section-box">
              <div class="section-title" style="color: #d81b60">
                <i class="bi bi-list-check"></i>
                รายการที่เพิ่มแล้ว
                <span class="count-pill" *ngIf="saleDraftItems.length > 0">
                  {{ saleDraftItems.length }}
                </span>
              </div>

              <div *ngIf="saleDraftItems.length === 0" class="empty-draft">
                ยังไม่มีรายการขาย
              </div>

              <div
                *ngIf="saleDraftItems.length > 0"
                class="sale-list scroll-area"
              >
                <div class="sale-row sale-head">
                  <div>สินค้า</div>
                  <div style="text-align: center">จำนวน</div>
                  <div></div>
                </div>

                <div
                  class="sale-row sale-item"
                  *ngFor="let it of saleDraftItems"
                >
                  <div class="sale-name">
                    <div class="sale-title">{{ it.name }}</div>
                    <div class="sale-sub">
                      {{ it.category }} • คงเหลือ {{ it.stock }}
                    </div>
                  </div>

                  <div class="sale-qty" style="text-align: center">
                    <input
                      type="number"
                      min="1"
                      [max]="it.stock"
                      [ngModel]="it.sellQty"
                      (ngModelChange)="updateDraftQty(it.id, $event)"
                      class="draft-qty-input"
                    />
                  </div>

                  <div class="sale-del" style="text-align: right">
                    <button
                      class="btn-delete"
                      type="button"
                      (click)="removeSaleItem(it.id)"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ✅ ปุ่มย้ายไป “ล่างสุดของ modal” -->
          <div class="create-card-footer history-footer">
            <button
              class="btn-cancel"
              (click)="closeHistoryForm()"
              [disabled]="isSubmittingHistory"
            >
              <i class="bi bi-x-square"></i> ยกเลิก
            </button>

            <button
              class="btn-save"
              (click)="confirmSendToHistory()"
              [disabled]="saleDraftItems.length === 0 || isSubmittingHistory"
            >
              <i class="pi pi-check-square"></i> ยืนยัน
            </button>
          </div>
        </div>
        <!-- TABLE -->
        <p-table
          #dt
          [value]="filteredProducts"
          dataKey="code"
          [rows]="10"
          [paginator]="true"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="แสดง {first} ถึง {last} จากทั้งหมด {totalRecords} รายการ"
          [globalFilterFields]="[
            'name',
            'category',
            'quantity',
            'price',
            'date',
          ]"
          [scrollable]="true"
          scrollHeight="500px"
          stripedRows
          [tableStyle]="{ width: '100%', 'table-layout': 'fixed' }"
        >
          <!-- header -->
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="date" scope="col">
                วันที่ <p-sortIcon field="date"></p-sortIcon>
              </th>

              <th pSortableColumn="name" scope="col">
                ชื่อสินค้า <p-sortIcon field="name"></p-sortIcon>
              </th>

              <th pSortableColumn="category" scope="col">
                ประเภท <p-sortIcon field="category"></p-sortIcon>
              </th>

              <th pSortableColumn="quantity" scope="col">
                จำนวน <p-sortIcon field="quantity"></p-sortIcon>
              </th>

              <th pSortableColumn="price" scope="col">
                ราคา <p-sortIcon field="price"></p-sortIcon>
              </th>

              <th style="width: 10%" scope="col"></th>
            </tr>
          </ng-template>

          <!-- body -->
          <ng-template pTemplate="body" let-product let-i="rowIndex">
            <tr>
              <!-- DATE -->
              <td>
                <ng-container *ngIf="editIndex !== i; else editDate">
                  {{ product.date | date: 'dd/MM/yyyy' }}
                </ng-container>
                <ng-template #editDate>
                  <input
                    type="date"
                    [(ngModel)]="editProduct!.date"
                    name="editDate"
                  />
                </ng-template>
              </td>

              <!-- NAME -->
              <td
                style="
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                "
              >
                <ng-container *ngIf="editIndex !== i; else editName">
                  {{ product.name }}
                </ng-container>
                <ng-template #editName>
                  <select
                    class="p-inputtext p-component"
                    [(ngModel)]="editProduct!.name"
                    name="editName"
                    (change)="onEditNameChange(editProduct!.name)"
                  >
                    <option value="" disabled>-- เลือกชื่อสินค้า --</option>
                    <option *ngFor="let n of names" [value]="n.value">
                      {{ n.label }}
                    </option>
                  </select>
                </ng-template>
              </td>

              <!-- CATEGORY -->
              <td>
                <ng-container *ngIf="editIndex !== i; else editCategory">
                  {{ product.category }}
                </ng-container>
                <ng-template #editCategory>
                  <select
                    class="p-inputtext p-component"
                    [(ngModel)]="editProduct!.category"
                    name="editCategory"
                  >
                    <option value="" disabled>-- เลือกประเภท --</option>
                    <option *ngFor="let c of categories" [value]="c.value">
                      {{ c.label }}
                    </option>
                  </select>
                </ng-template>
              </td>

              <!-- QUANTITY -->
              <td>
                <ng-container *ngIf="editIndex !== i; else editQty">
                  {{ product.quantity }}
                </ng-container>
                <ng-template #editQty>
                  <input
                    type="number"
                    min="1"
                    step="1"
                    [ngModel]="editProduct!.quantity"
                    name="editQty"
                    (ngModelChange)="editProduct!.quantity = toInt($event, 1)"
                  />
                </ng-template>
              </td>

              <!-- PRICE -->
              <td>
                <ng-container *ngIf="editIndex !== i; else editPrice">
                  {{ product.price | number: '1.0-0' }}
                </ng-container>
                <ng-template #editPrice>
                  <input
                    type="number"
                    min="0"
                    step="1"
                    [ngModel]="editProduct!.price"
                    name="editPrice"
                    (ngModelChange)="editProduct!.price = toInt($event, 0)"
                  />
                </ng-template>
              </td>

              <!-- ACTION -->
              <td style="display: flex; gap: 8px; justify-content: flex-end">
                <button
                  *ngIf="editIndex !== i"
                  class="btn-edit"
                  (click)="onEdit(i)"
                >
                  <i class="bi bi-pen"></i>
                </button>

                <button
                  *ngIf="editIndex !== i"
                  class="btn-delete"
                  (click)="onDelete(i)"
                >
                  <i class="bi bi-trash"></i>
                </button>

                <button
                  *ngIf="editIndex === i"
                  class="btn-save"
                  (click)="onSave(i)"
                >
                  <i class="pi pi-check-square"></i>
                </button>

                <button
                  *ngIf="editIndex === i"
                  class="btn-cancel"
                  (click)="onCancel()"
                >
                  <i class="bi bi-x-square"></i>
                </button>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6">ไม่พบข้อมูล</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>
